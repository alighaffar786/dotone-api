var ADLINKS=ADLINKS||{source:function(e){return"production"===e?"https://api.pub.affiliates.one/api/v2/affiliates/links/generate":"staging"===e?"http://staging.api.affiliates.com.tw/api/v1/affiliates/links/generate":"http://localhost:4000/api/v2/affiliates/links/generate"},debounceMap:new Map,debounce:function(e,t){t=t||"timeout";var n=this,i=3e3;n.debounceMap.has(t)&&clearTimeout(n.debounceMap.get(t));var o=setTimeout(function(){e(),n.debounceMap["delete"](t)},i);n.debounceMap.set(t,o)},mergeObj:function(){for(var e,t={},n=0,i=arguments.length;n<i;n++)for(e in arguments[n])arguments[n].hasOwnProperty(e)&&(t[e]=arguments[n][e]);return t},needToRefresh:function(e,t){if("1"===window.localStorage.getItem("adLinkInvalid"))return!1;for(var n=0;n<e.length;++n)if(t.indexOf(e[n])<0)return!0;return!1},observeDOM:function(){var i=window.MutationObserver||window.WebKitMutationObserver;return function(e,t){if(e&&1===e.nodeType){if(i){var n=new i(t);return n.observe(e,{childList:!0,subtree:!0}),n}window.addEventListener&&(e.addEventListener("DOMNodeInserted",t,!1),e.addEventListener("DOMNodeRemoved",t,!1))}}}(),getAdLinkUrls:function(){var e=(new Date).getDay().toString(),t=window.localStorage.getItem("adLinkExpiration");return t&&t===e?JSON.parse(window.localStorage.getItem("adLinkUrls")):(window.localStorage.removeItem("adLinkUrls"),{})},setAdLinkUrls:function(e){var t=this.getAdLinkUrls();window.localStorage.setItem("adLinkUrls",JSON.stringify(this.mergeObj(t,e))),window.localStorage.setItem("adLinkExpiration",(new Date).getDay())},getTrackingLinks:function(e,t,n){var i=ADLINKS.source(t.mode),o={},a=this;"object"==typeof n&&(o=n);var r=new XMLHttpRequest;r.onloadstart=function(){r.responseType="json"},r.addEventListener("load",function(){if(201===r.status)if("string"==typeof r.response){var e=JSON.parse(r.response);e.data&&a.setAdLinkUrls(e.data)}else a.setAdLinkUrls(r.response.data);else 404===r.status?window.localStorage.setItem("adLinkInvalid","1"):console.log(r.status+": "+r.statusText)}),r.open("POST",i),r.setRequestHeader("Content-type","application/json");var s=JSON.stringify({hostname:window.location.href,affiliate_id:t.affiliateId,channel_id:o.channelId,original_urls:e});r.send(s)},renderAdLinks:function(e,t){for(var n=document.getElementsByTagName("a"),i={},a=!1,r=!1,s=null,o={},d=document.createElement("a"),l=0;l<n.length;l++){var c=n[l],u=this;d.href=c.href,host=d.host.replace(/^www\./,""),host&&(o[host]=o[host]?o[host]+1:1);var f="converly-"+l;c.setAttribute("data-adlink-id",f),c.setAttribute("data-adlink-host",host),c.setAttribute("data-adlink-original",c.href),i[f]=c.href,c.onmousedown=function(e){try{var t=u.getAdLinkUrls()[this.getAttribute("data-adlink-host")].tracking_url;if(t){trackingUrl=t;var n=encodeURIComponent(this.href),i=trackingUrl.replace("-href-",n);i=i.replace("-link-id-",f),a=!0,2!==e.button&&(r=!0),(s=this).href=i}}catch(o){}}}document.onmouseup=function(){r=!1},document.onmousemove=function(){a&&!r&&s&&(s.href=s.getAttribute("data-adlink-original"),a=!1,s=null)};try{var g=this.getAdLinkUrls(),h=Object.keys(o),k=g&&Object.keys(g);console.log("AdLink is rendered"),this.needToRefresh(h,k)&&(console.log("AdLink is refreshed"),this.getTrackingLinks(i,e,t))}catch(v){console.log(v),this.getTrackingLinks(i,e,t)}},getLinks:function(e,t){function n(){console.log("AdLink is run"),i.renderAdLinks(e,t)}console.log("AdLink is active");var i=this;i.debounce(n);var o=document.querySelector("body");i.observeDOM(o,function(e){e.forEach(function(e){for(var t=0;t<e.addedNodes.length;t++){if("A"===e.addedNodes[t].nodeName){i.debounce(n);break}}})})}};