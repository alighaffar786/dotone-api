upstream app {
    server unix:<%= app_path %>/shared/sockets/puma.sock fail_timeout=0;
}

server {
    listen 80 default_server;

    server_name <%= server_names.join(' ') %>;

    client_header_timeout 3000;
    client_body_timeout 3000;
    fastcgi_read_timeout 3000;
    client_max_body_size 32m;
    fastcgi_buffers 8 128k;
    fastcgi_buffer_size 128k;

    <% disabled_paths.each do |path| %>
    location <%= path %> {
        return 404;
    }
    <% end %>

    <% available_paths.each do |path| %>
    location <%= path %> {
        proxy_pass http://app;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $host;
        proxy_redirect off;
        alias <%= app_path %>/public;
    }
    <% end %>

    <% if server_type == 'TRACK' %>
    location / {
        root <%= app_path %>/public/;
        log_not_found off;
    }
    <% end %>

    location = / {
        return 301 https://affiliates.one;
    }
}
